{
  "comments": [
    {
      "key": {
        "uuid": "9a437d4f_4f774ed5",
        "filename": "src/com/cyanogenmod/updater/service/DownloadCompleteIntentService.java",
        "patchSetId": 1
      },
      "lineNbr": 94,
      "author": {
        "id": 3671
      },
      "writtenOn": "2017-01-28T22:52:20Z",
      "side": 0,
      "message": "How can running this here corrupt the download? If that\u0027s truly what\u0027s happening, it should be corrupting when you run it later too, thereby verifying it and subsequently corrupting it.",
      "range": {
        "startLine": 94,
        "startChar": 16,
        "endLine": 94,
        "endChar": 31
      },
      "revId": "4b122c0c712668a43940039299d422e7cc4f7352",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9a437d4f_4f5e2e47",
        "filename": "src/com/cyanogenmod/updater/service/DownloadCompleteIntentService.java",
        "patchSetId": 1
      },
      "lineNbr": 94,
      "author": {
        "id": 12604
      },
      "writtenOn": "2017-01-28T23:19:44Z",
      "side": 0,
      "message": "It seems that the output stream is still writing to destFile when mDm.remove is called and it interrupts the write somehow.  Before the new download manager commit was made, the previous code also did not call mDm.remove right before verifyPackage.\n\nIt is not the verifyPackage that is corrupting the file.  The problem is that the output stream does not finish writing to destFile.",
      "parentUuid": "9a437d4f_4f774ed5",
      "range": {
        "startLine": 94,
        "startChar": 16,
        "endLine": 94,
        "endChar": 31
      },
      "revId": "4b122c0c712668a43940039299d422e7cc4f7352",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9a437d4f_1e73a84e",
        "filename": "src/com/cyanogenmod/updater/service/DownloadCompleteIntentService.java",
        "patchSetId": 9
      },
      "lineNbr": 84,
      "author": {
        "id": 7880
      },
      "writtenOn": "2017-02-01T11:41:17Z",
      "side": 0,
      "message": "According to the docs, DownloadManager.openDownloadedFile() is the only method in the original code that can throw an IOException, namely a FileNotFoundException.\n\nIf so, maybe something like this is simpler. I think the null checks aren\u0027t needed for this as well:\n\n ParcelFileDescriptor file \u003d null;\n try {\n     ParcelFileDescriptor file \u003d mDm.openDownloadedFile(id);\n } catch (FileNotFoundException e) {\n     displayErrorResult(updateIntent, R.string.unable_to_download_file);\n     mDm.remove(id);\n     return;\n }\n\n FileInputStream inStream \u003d new FileInputStream(file.getFileDescriptor());\n FileChannel inChannel \u003d inStream.getChannel();\n FileOutputStream outStream \u003d new FileOutputStream(destFile);\n FileChannel outChannel \u003d outStream.getChannel();\n inChannel.transferTo(0, inChannel.size(), outChannel);\n\n try {\n     inChannel.close();\n     outChannel.close();\n     inStream.close();\n     outStream.close();\n } catch (IOException e) {\n     // Ignore\n }\n\n mDm.remove(id);",
      "revId": "4b122c0c712668a43940039299d422e7cc4f7352",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9a437d4f_3e4e6cc2",
        "filename": "src/com/cyanogenmod/updater/service/DownloadCompleteIntentService.java",
        "patchSetId": 9
      },
      "lineNbr": 84,
      "author": {
        "id": 12604
      },
      "writtenOn": "2017-02-01T12:28:05Z",
      "side": 0,
      "message": "transferTo needs to be inside a try block because it throws an IOException.",
      "parentUuid": "9a437d4f_1e73a84e",
      "revId": "4b122c0c712668a43940039299d422e7cc4f7352",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9a437d4f_5d3815a0",
        "filename": "src/com/cyanogenmod/updater/service/DownloadCompleteIntentService.java",
        "patchSetId": 9
      },
      "lineNbr": 84,
      "author": {
        "id": 12604
      },
      "writtenOn": "2017-02-01T21:40:12Z",
      "side": 0,
      "message": "I tried this, but I keep getting a fatal runtime exception.\n\n           ParcelFileDescriptor file \u003d null;\n            try {\n                file \u003d mDm.openDownloadedFile(id);\n            } catch (FileNotFoundException e) {\n                displayErrorResult(updateIntent, R.string.unable_to_download_file);\n                mDm.remove(id);\n                return;\n            }\n\n            FileInputStream inStream \u003d new FileInputStream(file.getFileDescriptor());\n            FileChannel inChannel \u003d inStream.getChannel();\n            FileOutputStream outStream \u003d null;\n            try {\n                outStream \u003d new FileOutputStream(destFile);\n            } catch (FileNotFoundException e) {\n                // Ignore\n            }\n            FileChannel outChannel \u003d outStream.getChannel();\n\n            try {\n                inChannel.transferTo(0, inChannel.size(), outChannel);\n            } catch (IOException e) {\n                // Ignore\n            }\n\n            try {\n                inChannel.close();\n                outChannel.close();\n                inStream.close();\n                outStream.close();\n            } catch (IOException e) {\n                // Ignore\n            }\n\n            mDm.remove(id);\n\n\n\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: FATAL EXCEPTION: main\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: Process: org.lineageos.updater, PID: 4541\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: java.lang.RuntimeException: Unable to instantiate application com.cyanogenmod.updater.UpdateApplication: java.lang.ClassNotFoundException: Didn\u0027t find class \"com.cyanogenmod.updater.UpdateApplication\" on path: DexPathList[[zip file \"/system/priv-app/CMUpdater/CMUpdater.apk\"],nativeLibraryDirectories\u003d[/system/priv-app/CMUpdater/lib/arm, /system/lib, /vendor/lib, /system/lib, /vendor/lib]]\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat android.app.LoadedApk.makeApplication(LoadedApk.java:802)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat android.app.ActivityThread.handleBindApplication(ActivityThread.java:5384)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat android.app.ActivityThread.-wrap2(ActivityThread.java)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat android.app.ActivityThread$H.handleMessage(ActivityThread.java:1545)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat android.os.Handler.dispatchMessage(Handler.java:102)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat android.os.Looper.loop(Looper.java:154)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat android.app.ActivityThread.main(ActivityThread.java:6126)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat java.lang.reflect.Method.invoke(Native Method)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:886)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat com.android.internal.os.ZygoteInit.main(ZygoteInit.java:776)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: Caused by: java.lang.ClassNotFoundException: Didn\u0027t find class \"com.cyanogenmod.updater.UpdateApplication\" on path: DexPathList[[zip file \"/system/priv-app/CMUpdater/CMUpdater.apk\"],nativeLibraryDirectories\u003d[/system/priv-app/CMUpdater/lib/arm, /system/lib, /vendor/lib, /system/lib, /vendor/lib]]\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat dalvik.system.BaseDexClassLoader.findClass(BaseDexClassLoader.java:56)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat java.lang.ClassLoader.loadClass(ClassLoader.java:380)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat java.lang.ClassLoader.loadClass(ClassLoader.java:312)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat android.app.Instrumentation.newApplication(Instrumentation.java:993)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tat android.app.LoadedApk.makeApplication(LoadedApk.java:796)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t... 9 more\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \tSuppressed: java.io.IOException: No original dex files found for dex location /system/priv-app/CMUpdater/CMUpdater.apk\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.DexFile.openDexFileNative(Native Method)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.DexFile.openDexFile(DexFile.java:367)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.DexFile.\u003cinit\u003e(DexFile.java:112)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.DexFile.\u003cinit\u003e(DexFile.java:77)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.DexPathList.loadDexFile(DexPathList.java:359)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.DexPathList.makeElements(DexPathList.java:323)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.DexPathList.makeDexElements(DexPathList.java:263)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.DexPathList.\u003cinit\u003e(DexPathList.java:126)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.BaseDexClassLoader.\u003cinit\u003e(BaseDexClassLoader.java:48)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat dalvik.system.PathClassLoader.\u003cinit\u003e(PathClassLoader.java:64)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat com.android.internal.os.PathClassLoaderFactory.createClassLoader(PathClassLoaderFactory.java:43)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat android.app.ApplicationLoaders.getClassLoader(ApplicationLoaders.java:58)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat android.app.LoadedApk.createOrUpdateClassLoaderLocked(LoadedApk.java:520)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat android.app.LoadedApk.getClassLoader(LoadedApk.java:553)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat android.app.ActivityThread.getTopLevelResources(ActivityThread.java:1866)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat android.app.LoadedApk.getResources(LoadedApk.java:766)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat android.app.ContextImpl.\u003cinit\u003e(ContextImpl.java:2038)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat android.app.ContextImpl.createAppContext(ContextImpl.java:1983)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\tat android.app.ActivityThread.handleBindApplication(ActivityThread.java:5301)\n02-01 23:32:41.488  4541  4541 E AndroidRuntime: \t\t... 8 more",
      "parentUuid": "9a437d4f_1e73a84e",
      "revId": "4b122c0c712668a43940039299d422e7cc4f7352",
      "serverId": "1ec6b3db-b2c1-4fa4-84a2-4c7efe89ba71",
      "unresolved": false
    }
  ]
}